rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // یہ فنکشن چیک کرتا ہے کہ آیا یوزر لاگ ان ہے یا نہیں۔
    // It checks if the user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // یہ فنکشن چیک کرتا ہے کہ درخواست کرنے والا یوزر ہی دستاویز کا مالک ہے۔
    // It checks if the requesting user is the owner of the document (matching UID).
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // یہ فنکشن کسی چیٹ میں دونوں شراکت داروں کو چیک کرتا ہے۔
    // It checks if the user is one of the two participants in the chat.
    function isParticipant(participants) {
      return isSignedIn() && request.auth.uid in participants;
    }


    // 1. صارفین کا مجموعہ (Users Collection)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      // Allow any user to query to check for username availability during signup
      allow list: if true;
    }
    
    // 2. چیٹس اور میسجز کا مجموعہ (Chats Collection)
    match /chats/{chatId} {
      allow read, write: if isParticipant(resource.data.members);
      
      match /messages/{messageId} {
        allow read, write: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.members);
      }
    }
    
    // 3. دوستوں کی درخواستوں کا مجموعہ (Friend Requests Collection)
    match /friendRequests/{requestId} {
      allow read, update, delete: if isSignedIn() && (isOwner(resource.data.senderId) || isOwner(resource.data.receiverId));
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow list: if isSignedIn();
    }
    
    // 4. کال کی تاریخ کا مجموعہ (Call History Collection)
    match /calls/{callId} {
      allow read, write, delete: if isParticipant(resource.data.participants);
      // FIX: Updated rule to exactly match the query being made by the app.
      // The query filters by 'participants' and orders by 'timestamp'.
      allow list: if isSignedIn() && request.query.where[0].field == 'participants' && request.query.where[0].op == 'array-contains' && request.query.where[0].value == request.auth.uid;
    }

    // 5. ڈیلیٹ شدہ صارفین کا مجموعہ (Deleted Users Collection)
    match /deletedUsers/{email} {
      allow create: if true;
      allow read, write, delete: if false;
    }
  }
}
