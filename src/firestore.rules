rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // यह फंक्शन चेक करता है कि आया यوزر لاگ ان ہے یا نہیں۔
    // It checks if the user is authenticated.
    function isSignedIn() {
      return request.auth != null;
    }

    // यह फंक्शन चेक करता है कि درخواست करने वाला یوزر ہی دستاویز کا مالک ہے۔
    // It checks if the requesting user is the owner of the document (matching UID).
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // यह फंक्शन किसी چیٹ میں دونوں شراکت داروں کو چیک کرتا ہے۔
    // It checks if the user is one of the two participants in the chat.
    function isParticipant(participants) {
      return isSignedIn() && request.auth.uid in participants;
    }
    
    function isRoomOwner(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId)).data.ownerId == request.auth.uid;
    }
    
    function isRoomMember(roomId) {
      return exists(/databases/$(database)/documents/rooms/$(roomId)/members/$(request.auth.uid));
    }


    // 1. صارفین کا مجموعہ (Users Collection)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      // Allow list for username search for any signed in user.
      // The client-side query filters out disabled users for non-admins.
      // Super admins can see all users in their dedicated panel.
      allow list: if isSignedIn();
    }
    
    // 2. چیٹس اور میسجز کا مجموعہ (Chats Collection)
    match /chats/{chatId} {
      allow read, write: if isParticipant(resource.data.members);
      
      match /messages/{messageId} {
        allow read, write: if isParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data.members);
      }
    }
    
    // 3. دوستوں کی درخواستوں کا مجموعہ (Friend Requests Collection)
    match /friendRequests/{requestId} {
      allow read, update, delete: if isSignedIn() && (isOwner(resource.data.senderId) || isOwner(resource.data.receiverId));
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow list: if isSignedIn();
    }
    
    // 4. کال کی تاریخ کا مجموعہ (Call History Collection)
    match /calls/{callId} {
      // The query `where('participants', 'array-contains', request.auth.uid)` ensures a user can only query their own calls.
      // The `list` rule allows this query to execute.
      // Individual document access is still protected by `get` and `write` rules.
      allow list: if isSignedIn();
      allow get, write, delete: if isParticipant(resource.data.participants);
    }

    // 5. ڈیلیٹ شدہ صارفین کا مجموعہ (Deleted Users Collection)
    match /deletedUsers/{email} {
      allow create: if true;
      allow read, write, delete: if false;
    }
    
    // 6. وائس چیٹ رومز کا مجموعہ (Voice Chat Rooms Collection)
    match /rooms/{roomId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn(); // This rule allows any signed-in user to list all rooms.
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
        allow update: if isRoomOwner(roomId);
        allow delete: if isRoomOwner(roomId);
        
        match /members/{userId} {
            allow read: if isRoomMember(roomId);
            allow create: if isOwner(userId); // A user can add themselves
            allow update: if isOwner(userId) || isRoomOwner(roomId); // A user can update their own status, or the owner can
            allow delete: if isOwner(userId) || isRoomOwner(roomId); // A user can leave, or the owner can kick them
        }
        
        match /messages/{messageId} {
          allow read, create: if isRoomMember(roomId);
          allow update, delete: if isOwner(request.resource.data.senderId) || isRoomOwner(roomId);
        }
    }
  }
}
