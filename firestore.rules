rules_version = '2';

function isAuthenticated() {
  return request.auth != null;
}

// Function to check if the requesting user has been blocked by the target user.
// User 'A' (requester) wants to read User 'B's (targetUserId) profile.
// This function checks if User B has blocked User A.
// Firestore path: /users/$(targetUserId) -> data.blockedUsers
// This is used to prevent User A from seeing User B's profile if B blocked A.
function isNotBlockedByTarget(targetUserId) {
  // Allow if the target user's document doesn't exist, or if the blockedUsers field doesn't exist,
  // or if the requester's UID is not in the target's blockedUsers list.
  return !exists(/databases/$(database)/documents/users/$(targetUserId)) ||
         !('blockedUsers' in get(/databases/$(database)/documents/users/$(targetUserId)).data) ||
         !(request.auth.uid in get(/databases/$(database)/documents/users/$(targetUserId)).data.blockedUsers);
}


// Function to check if the requesting user has blocked the target user.
// User 'A' (requester) wants to do something related to User 'B' (targetUserId).
// This function checks if User A has blocked User B.
// Firestore path: /users/$(request.auth.uid) -> data.blockedUsers
// This is used to prevent User A from sending messages to User B if A blocked B.
function hasNotBlockedTarget(targetUserId) {
    // Check my own user document to see if I have blocked the other person.
    return !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
           !('blockedUsers' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data) ||
           !(targetUserId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.blockedUsers);
}


service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      // Allow reading a user's profile ONLY if the requester is not on that user's block list.
      // A user can always read their own profile.
      allow get: if isAuthenticated() && (request.auth.uid == userId || isNotBlockedByTarget(userId));
      
      // A user can list other users. The client must filter out users who have blocked the requester.
      // The 'get' rule above will prevent fetching full details of a user who has blocked the requester.
      allow list: if isAuthenticated();

      // A user can create, update, or delete their own profile document.
      allow create, update, delete: if isAuthenticated() && request.auth.uid == userId;
    }

    match /friendRequests/{requestId} {
      // Receiver can read the request
      allow get: if isAuthenticated() && get(/databases/$(database)/documents/friendRequests/$(requestId)).data.receiverId == request.auth.uid;
      
      // Sender can create the request
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;

      // Receiver can accept/reject (update/delete)
      allow update, delete: if isAuthenticated() && get(/databases/$(database)/documents/friendRequests/$(requestId)).data.receiverId == request.auth.uid;
    }

    match /chats/{chatId} {
        // Only members of the chat can interact with it.
        allow read, update, delete: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
        
        // Anyone authenticated can create a chat (this is handled in a batch write with friend request acceptance)
        allow create: if isAuthenticated();
    }
    
    match /chats/{chatId}/messages/{messageId} {
       // A message can only be created if:
       // 1. The sender is a member of the chat.
       // 2. The sender has NOT been blocked by the other member.
       // 3. The sender has NOT blocked the other member.
       allow create: if isAuthenticated() &&
                      request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members &&
                      isNotBlockedByTarget(get(/databases/$(database)/documents/chats/$(chatId)).data.members.filter(m => m != request.auth.uid)[0]) &&
                      hasNotBlockedTarget(get(/databases/$(database)/documents/chats/$(chatId)).data.members.filter(m => m != request.auth.uid)[0]);
                      
      // Members of the chat can read, list, update, and delete messages.
      // Read access is controlled at the chat document level.
      allow read, list, update, delete: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
    }
  }
}
